<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DataScraper</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-VzPwz5yia9mBStQ9ftnznuaCG2lLBVmOAXoJ2i8LojRxur2jcWc58SUaYG3wxY5E" crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
</head>
<body class="bg-light">
  <div class="container my-4 app-container">
    <div class="app-topbar d-flex justify-content-between align-items-center mb-4">
      <div class="h5 mb-0">DataScraper_Prototype</div>
      <div class="text-muted small">Prototype for parcel &amp; zoning analysis</div>
    </div>

    <section class="card input-card shadow-sm rounded-4 mb-4">
      <div class="card-body">
        {% if error_message %}
          <div class="alert alert-warning mb-3" role="alert">{{ error_message }}</div>
        {% endif %}
        <form method="POST" action="{{ url_for('index') }}">
          <div class="row g-4">
            <div class="col-md-6">
              <label class="section-title d-block">Address</label>
              <input type="text" class="form-control rounded-3" name="address" placeholder="e.g., Mestni trg 1, Ljubljana" value="{{ raw_data.input.original_address if raw_data else '' }}">
              <div class="form-text text-muted">Street, number, city</div>
            </div>
            <div class="col-md-6">
              <label class="section-title d-block">Parcel number</label>
              <input type="text" class="form-control rounded-3" name="parcel" placeholder="e.g., 1234/5 k.o. Center" value="{{ raw_data.input.original_parcel if raw_data else '' }}">
              <div class="form-text text-muted">Format: 1234/5 k.o. Center</div>
            </div>
          </div>
          <div class="d-flex align-items-center gap-3 mt-4 flex-wrap">
            <button type="submit" name="mode" value="api" class="btn btn-primary btn-main">Get data</button>
            <button type="submit" name="mode" value="browser" class="btn btn-outline-secondary btn-secondary-main">Advanced web lookup</button>
            <div class="text-muted small">Advanced lookup may be slower (launches headless browser).</div>
          </div>
        </form>
      </div>
    </section>

    {% if ai_summary %}
    <div class="card result-card section-card">
      <div class="card-header section-header d-flex justify-content-between align-items-center">
        <span>Parcel info</span>
        <button class="btn btn-outline-secondary btn-sm expand-toggle" data-target="#parcelText">expand</button>
      </div>
      <div class="card-body">
        <div id="parcelText" data-short="{{ ai_summary.parcel_section.short }}" data-long="{{ ai_summary.parcel_section.long }}">{{ ai_summary.parcel_section.short }}</div>
      </div>
    </div>

    {% if ai_summary.building_section %}
    <div class="card result-card section-card">
      <div class="card-header section-header d-flex justify-content-between align-items-center">
        <span>Building</span>
        <button class="btn btn-outline-secondary btn-sm expand-toggle" data-target="#buildingText">expand</button>
      </div>
      <div class="card-body">
        <div id="buildingText" data-short="{{ ai_summary.building_section.short }}" data-long="{{ ai_summary.building_section.long }}">{{ ai_summary.building_section.short }}</div>
      </div>
    </div>
    {% endif %}

    <div class="card result-card section-card">
      <div class="card-header section-header d-flex justify-content-between align-items-center">
        <span>Zoning &amp; layers</span>
        <button class="btn btn-outline-secondary btn-sm expand-toggle" data-target="#zoningText">expand</button>
      </div>
      <div class="card-body">
        <div id="zoningText" data-short="{{ ai_summary.zoning_section.short }}" data-long="{{ ai_summary.zoning_section.long }}">{{ ai_summary.zoning_section.short }}</div>
      </div>
    </div>

    <div class="card result-card section-card">
      <div class="card-header section-header">
        Relevant regulations
      </div>
      <div class="card-body">
        {% if ai_summary.regulations_section %}
          <div class="list-group list-group-flush">
            {% for reg in ai_summary.regulations_section %}
            <div class="list-group-item px-0">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ reg.law }}</div>
                  <div class="small text-muted" id="reg-{{ loop.index }}" data-short="{{ reg.short }}" data-long="{{ reg.long }}">{{ reg.short }}</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm expand-toggle" data-target="#reg-{{ loop.index }}">expand</button>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-muted">No regulations found yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="card result-card section-card">
      <div class="card-header section-header d-flex justify-content-between align-items-center">
        <span>Summary</span>
        <button class="btn btn-outline-secondary btn-sm expand-toggle" data-target="#summaryText">expand</button>
      </div>
      <div class="card-body">
        <div id="summaryText" data-short="{{ ai_summary.summary_section.short }}" data-long="{{ ai_summary.summary_section.long }}">{{ ai_summary.summary_section.short }}</div>
      </div>
    </div>

    <div class="card result-card section-card">
      <div class="card-header section-header">
        Sources used
      </div>
      <div class="card-body">
        {% if ai_summary.sources %}
          <ul class="mb-0">
            {% for source in ai_summary.sources %}
              <li>{{ source }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">Sources will appear once data is fetched.</div>
        {% endif %}
      </div>
    </div>

    <div class="card result-card section-card">
      <div class="card-header section-header">
        Poročilo (preview)
      </div>
      <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">
Lokacija / parcela:
{{ ai_summary.parcel_section.short }}

Vrsta pozidave:
{% if ai_summary.building_section %}{{ ai_summary.building_section.short }}{% else %}Podatki o vrsti pozidave niso na voljo.{% endif %}

Prostorski pogoji:
{{ ai_summary.zoning_section.short }}

Relevantni predpisi:
{% for reg in ai_summary.regulations_section %}
- {{ reg.law }}: {{ reg.short }}
{% endfor %}

Sklep / povzetek:
{{ ai_summary.summary_section.short }}
        </pre>
        <form action="/download-report" method="POST" class="mt-3">
          <button class="btn btn-primary btn-sm" type="submit">
            Download .txt
          </button>
        </form>
      </div>
    </div>
    {% endif %}

    {% if not ai_summary %}
      <div class="text-center text-muted py-4">
        Provide an address or parcel number and click “Get data” to start.
      </div>
    {% endif %}

    <div id="about-card" class="card section-card">
      <div class="card-header section-header">About this tool</div>
      <div class="card-body">
        <p class="mb-2">This prototype fetches parcel, zoning, and regulation data from eProstor, Urbinfo, and PISRS, then summarizes the findings with AI.</p>
        <p class="mb-0">If APIs are insufficient, an advanced web lookup will automate official viewers using Playwright.</p>
      </div>
    </div>

    <div id="howto-card" class="card section-card">
      <div class="card-header section-header">How to use</div>
      <div class="card-body">
        <ol class="fw-semibold mb-0">
          <li>Enter an address or parcel number.</li>
          <li>Click “Get data”.</li>
          <li>Review parcel, zoning, and regulations.</li>
          <li>Use “expand” to view longer AI explanations.</li>
          <li>If needed, run the advanced web lookup for deeper scraping.</li>
        </ol>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-9NDLZwcykIOSh5sVwqZGx1RIFVQGryuVKy7jH9MuNoMNFcQJUO2c+hJ1ytY1/6Yr" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('click', (event) => {
      const button = event.target.closest('.expand-toggle');
      if (!button) return;
      const targetSelector = button.getAttribute('data-target');
      const targetEl = document.querySelector(targetSelector);
      if (!targetEl) return;
      const shortText = targetEl.getAttribute('data-short') || '';
      const longText = targetEl.getAttribute('data-long') || shortText;
      const expanded = targetEl.getAttribute('data-expanded') === 'true';
      if (expanded) {
        targetEl.textContent = shortText;
        targetEl.setAttribute('data-expanded', 'false');
        button.textContent = 'expand';
      } else {
        targetEl.textContent = longText;
        targetEl.setAttribute('data-expanded', 'true');
        button.textContent = 'collapse';
      }
    });
  </script>
</body>
</html>


